<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio</title>
    <link rel="stylesheet" href="CSS/bootstrap.css">
    <link rel="stylesheet" href="CSS/cardapio.css">
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <script src="JS/bootstrap.bundle.js"></script>
    <script src="INDEX/JS/jquery.js"></script>
    <script src="INDEX/JS/sweetalert2.js"></script>
    <link rel="stylesheet" href="INDEX/CSS/sweetalert2.css">
</head>
<style>

html, body {
  height: 100%;
  display: flex;
  flex-direction: column;
}

body {
  flex: 1;
}

main {
  flex-grow: 1;
}

.barra-footer {
  background-color: var(--laranja-claro);
  text-align: center;
}

.fundo-footer{
    background-color: var(--laranja-claro);
}

.btn-acoes {
    all: unset; /* Remove todos os estilos aplicados pelo navegador */
    cursor: pointer; /* Adiciona o cursor de clique */
}

</style>
<body class="bg-corpo">
    <nav class="navbar navbar-expand bg-cardapio">
        <div class="container-fluid">
            <div class="nome-empresa" id="nomeDaEmpresa"></div>
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <!-- Ícone de QR Scan que abre o modal -->
                <li class="nav-item">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#qrModal" class="nav-link"><i class='bx bx-qr-scan fs-3'></i></a>
                </li>
                <li class="nav-item">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#pedtModal" class="nav-link botao-ver-pedidos"><i class='bx bxs-detail fs-3'></i></a>
                </li>
                <!-- Ícone de Carrinho que abre o modal -->
                <li class="nav-item">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#cartModal" class="nav-link botao-ver-carrinho"><i class='bx bxs-cart fs-3'></i></a>
                </li>
            </ul>
        </div>
    </nav>

    <main>
        <p style="color: #fef9dc;">http://localhost/SmartChef-main/cardapio.html?SCempresaId=1&SCnumeroMesa=1&SCtokenMesa=TOKEN_MESA_1</p>
        <div class="container corpo" id="CARDAPIO_DA_EMPRESA"></div>
        
        <!-- Modal do QR Scan -->
        <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="qrModalLabel">Leitura QR Code</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body align-items-center" >
                        <figure style="justify-content: center; display: flex;" id="QR_CODE_CARDAPIO"></figure>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal do Carrinho -->
        <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cartModalLabel">Carrinho</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-2" id="dadosDoCarrinho"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn botao-concluir">Concluir</button>
                        <button type="button" class="btn botao-fechar" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

         <!-- Modal dos Pedidos Feitos -->
         <div class="modal fade" id="pedtModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cartModalLabel">Pedidos Feitos Anteriormente</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-2" id="dadosDePedidosRealizados"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn botao-fechar" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="fundo-footer">
    <footer class="barra-footer text-light py-3">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>Contato</h5>
                    <p>
                        <strong>Email:</strong> contato@smartchef.com<br>
                        <strong>Telefone:</strong> (00) 1234-5678
                    </p>
                </div>
                <div class="col-md-4">
                    <h5>Links Úteis</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-light">Home</a></li>
                        <li><a href="#" class="text-light">Sobre Nós</a></li>
                        <li><a href="#" class="text-light">Cardápio</a></li>
                        <li><a href="#" class="text-light">Contato</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Siga-nos</h5>
                    <p>
                        <a href="#" class="text-light"><i class='bx bxl-facebook fs-4'></i></a>
                        <a href="#" class="text-light"><i class='bx bxl-instagram fs-4'></i></a>
                        <a href="#" class="text-light"><i class='bx bxl-twitter fs-4'></i></a>
                    </p>
                </div>
            </div>
            <div class="text-center mt-3">
                <p>© 2024 SmartChef. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>
    </div>
    
<script src="JS/bootstrap.bundle.js"></script>
<script>
    $(document).ready(function() {
        load();
        geraQRCode();
        getNomeDaEmpresa();
    });

    $(document).on('click', '.botao-adicionar-ao-carrinho', function (e) {
        e.preventDefault();

        // Obtém o ID do formulário a partir do atributo data-form-id
        var formId = $(this).data('form-id');

        // Seleciona o formulário e serializa os dados
        var formData = $('#' + formId).serialize();

        // Envia os dados via AJAX
        $.ajax({
            url: './INDEX/SRC/adicionarAoCarrinho.php', // Substitua pelo seu arquivo PHP
            type: 'POST',
            data: formData,
            success: function (response) {
                
                Swal.fire({
                    title: 'Sucesso!',
                    text: 'Pedido adicionado ao carrinho com sucesso!', // Mensagem de sucesso
                    icon: 'success',
                    confirmButtonText: 'Ok'
                });
            },
            error: function (xhr, status, error) {
                
                Swal.fire({
                    title: 'Erro',
                    text: 'Erro ao adicionar itens ao carrinho!', // Mensagem de sucesso
                    icon: 'error',
                    confirmButtonText: 'Ok'
                });
            }
        });
    });

    $(document).on('click', '.botao-ver-carrinho', function (e) {
        e.preventDefault();
        carregarDadosDoCarrinho();
    });

    $(document).on('click', '.botao-ver-pedidos', function (e) {
        e.preventDefault();
        carregarPedidosJaFeitos();
    });

    function carregarDadosDoCarrinho(){

        // Captura os parâmetros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const empresaId = urlParams.get('SCempresaId');
        const numeroMesa = urlParams.get('SCnumeroMesa');
        const tokenMesa = urlParams.get('SCtokenMesa');

        // Se os parâmetros não forem encontrados, você pode exibir um erro ou definir um valor padrão
        if (!empresaId || !numeroMesa || !tokenMesa) {
            Swal.fire({
                title: 'Erro',
                text: 'Erro ao abrir o carrinho!',
                icon: 'error',
                confirmButtonText: 'Ok'
            });
            return;
        }

        // Constrói a URL com os parâmetros
        const getDadosDoCarrinho = `./INDEX/SRC/getItensDoCarrinho.php?SCempresaId=${empresaId}&SCnumeroMesa=${numeroMesa}&SCtokenMesa=${tokenMesa}`;

        // Envia os dados via AJAX
        $.ajax({
            url: getDadosDoCarrinho, // Substitua pelo seu arquivo PHP
            type: 'POST',
            success: function (data) {
                
                $('#dadosDoCarrinho').html(data);
            },
            error: function () {
                
                Swal.fire({
                    title: 'Erro',
                    text: 'Erro ao carregar itens do carrinho!', // Mensagem de sucesso
                    icon: 'error',
                    confirmButtonText: 'Ok'
                });
            }
        });
    }

    function carregarPedidosJaFeitos(){

    // Captura os parâmetros da URL
    const urlParams = new URLSearchParams(window.location.search);
    const empresaId = urlParams.get('SCempresaId');
    const numeroMesa = urlParams.get('SCnumeroMesa');
    const tokenMesa = urlParams.get('SCtokenMesa');

    // Se os parâmetros não forem encontrados, você pode exibir um erro ou definir um valor padrão
    if (!empresaId || !numeroMesa || !tokenMesa) {
        Swal.fire({
            title: 'Erro',
            text: 'Erro carregar pedidos!',
            icon: 'error',
            confirmButtonText: 'Ok'
        });
        return;
    }

    // Constrói a URL com os parâmetros
    const getPedidosJaFeitos = `./INDEX/SRC/getPedidosJaFeitos.php?SCempresaId=${empresaId}&SCnumeroMesa=${numeroMesa}&SCtokenMesa=${tokenMesa}`;

    // Envia os dados via AJAX
    $.ajax({
        url: getPedidosJaFeitos, // Substitua pelo seu arquivo PHP
        type: 'POST',
        success: function (data) {
            
            $('#dadosDePedidosRealizados').html(data);
        },
        error: function () {
            
            Swal.fire({
                title: 'Erro',
                text: 'Erro ao carregar pedidos já realizados!', // Mensagem de sucesso
                icon: 'error',
                confirmButtonText: 'Ok'
            });
        }
    });
    }

    $(document).on('click', '.btn-adicionar-item', function (e) {
        e.preventDefault();
        
        const itemId = $(this).val();
        const addQtDoItem = `./INDEX/SRC/addQtDoItem.php?SCitemId=${itemId}`;

        $.ajax({
            url: addQtDoItem, // Substitua pelo seu arquivo PHP
            type: 'POST',
            success: function () {
                
                carregarDadosDoCarrinho();
            },
            error: function () {
                
                Swal.fire({
                    title: 'Erro',
                    text: 'Erro ao adicionar item ao carrinho!', // Mensagem de sucesso
                    icon: 'error',
                    confirmButtonText: 'Ok'
                });
            }
        });
    });

    $(document).on('click', '.btn-subtrair-item', function (e) {
        e.preventDefault();
        
        const itemId = $(this).val();
        const subQtDoItem = `./INDEX/SRC/subQtDoItem.php?SCitemId=${itemId}`;

        $.ajax({
            url: subQtDoItem, // Substitua pelo seu arquivo PHP
            type: 'POST',
            success: function () {
                
                carregarDadosDoCarrinho();
            },
            error: function () {
                
                Swal.fire({
                    title: 'Erro',
                    text: 'Erro ao reduzir item do carrinho!', // Mensagem de sucesso
                    icon: 'error',
                    confirmButtonText: 'Ok'
                });
            }
        });
    });

    $(document).on('click', '.btn-remover-item', function (e) {
        e.preventDefault();
        
        const itemId = $(this).val();
        const remQtDoItem = `./INDEX/SRC/removeItemDoCarrinho.php?SCitemId=${itemId}`;

        $.ajax({
            url: remQtDoItem, // Substitua pelo seu arquivo PHP
            type: 'POST',
            success: function () {
                
                carregarDadosDoCarrinho();
            },
            error: function () {
                
                Swal.fire({
                    title: 'Erro',
                    text: 'Erro ao remover item do carrinho!', // Mensagem de sucesso
                    icon: 'error',
                    confirmButtonText: 'Ok'
                });
            }
        });
    });

    $(document).on('click', '.botao-concluir', function (e) {
        e.preventDefault();
        
        const urlParams = new URLSearchParams(window.location.search);
        const empresaId = urlParams.get('SCempresaId');
        const numeroMesa = urlParams.get('SCnumeroMesa');
        const tokenMesa = urlParams.get('SCtokenMesa');

        // Se os parâmetros não forem encontrados, você pode exibir um erro ou definir um valor padrão
        if (!empresaId || !numeroMesa || !tokenMesa) {
            console.error('Parâmetros da mesa não encontrados na URL');
            return;
        }

        const setPedidoDoCarrinho = `./INDEX/SRC/setPedidoDoCarrinho.php?SCempresaId=${empresaId}&SCnumeroMesa=${numeroMesa}&SCtokenMesa=${tokenMesa}`;

        $.ajax({
            url: setPedidoDoCarrinho, 
            type: 'POST',
            success: function () {
                
                carregarDadosDoCarrinho();

                Swal.fire({
                    title: 'Sucesso!',
                    text: 'Pedido enviado para cozinha com sucesso!',
                    icon: 'success',
                    confirmButtonText: 'Ok'
                });
            },
            error: function () {
                
                Swal.fire({
                    title: 'Erro',
                    text: 'Erro ao concluir seu pedido, carrinho vazio ou falha no processo!',
                    icon: 'error',
                    confirmButtonText: 'Ok'
                });
            }
        });
    });

    function getNomeDaEmpresa(){
        
        const urlParams = new URLSearchParams(window.location.search);
        const empresaId = urlParams.get('SCempresaId');

        if (!empresaId) {
            $('#nomeDaEmpresa').html("<h5>Empresa não identificada</h5>");
            return;
        }else{

            const getNomeDaEmpresaUrl = `./INDEX/SRC/getNomeDaEmpresa.php?SCempresaId=${empresaId}`;
            $.ajax({
                url: getNomeDaEmpresaUrl,
                success: function (data) {
                    $('#nomeDaEmpresa').html(data);
                },
                error: function () {
                    $('#nomeDaEmpresa').html("<h5>Empresa ID invalido</h5>");
                }
            });

        }
    }

    function load() {
        // Captura os parâmetros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const empresaId = urlParams.get('SCempresaId');
        const numeroMesa = urlParams.get('SCnumeroMesa');
        const tokenMesa = urlParams.get('SCtokenMesa');

        // Se os parâmetros não forem encontrados, você pode exibir um erro ou definir um valor padrão
        if (!empresaId || !numeroMesa || !tokenMesa) {
            console.error('Parâmetros da mesa não encontrados na URL');
            return;
        }

        // Constrói a URL com os parâmetros
        const getCardapioUrl = `INDEX/SRC/getCardapio.php?SCempresaId=${empresaId}&SCnumeroMesa=${numeroMesa}&SCtokenMesa=${tokenMesa}`;

        // Faz a requisição AJAX
        $.ajax({
            url: getCardapioUrl,
            success: function (data) {
                $('#CARDAPIO_DA_EMPRESA').html(data);
            },
            error: function () {
                $('#CARDAPIO_DA_EMPRESA').html("<p class='text-center'>Erro ao carregar cardapio! Seu link é invalido, peça ao Garçom para lhe dar o QR Code de acesso</p>");
            }
        });
    }

    function geraQRCode() {
        // Captura os parâmetros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const empresaId = urlParams.get('SCempresaId');
        const numeroMesa = urlParams.get('SCnumeroMesa');
        const tokenMesa = urlParams.get('SCtokenMesa');

        // Se os parâmetros não forem encontrados, você pode exibir um erro ou definir um valor padrão
        if (!empresaId || !numeroMesa || !tokenMesa) {
            $('#QR_CODE_CARDAPIO').html("<p>Você não possui todos os identificadores! Peça ao Garçom para gerar um QR Code para voce.</p>");
            return;
        }

        // Constrói a URL com os parâmetros
        const getQRCodeUrl = `INDEX/SRC/apiQRCode.php?SCempresaId=${empresaId}&SCnumeroMesa=${numeroMesa}&SCtokenMesa=${tokenMesa}`;

        // Faz a requisição AJAX
        $.ajax({
            url: getQRCodeUrl,
            success: function (data) {
                $('#QR_CODE_CARDAPIO').html(data);
            },
            error: function () {
                $('#QR_CODE_CARDAPIO').html("<p>Identificadores invalidos! Peça ao Garçom para gerar um novo QR Code para voce.</p>");
            }
        });
    }
</script>
</body>
</html>
